<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#dc2626">
    <title>Campeonato de Kart</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 50px;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1, h2, h3 { color: #333; margin-bottom: 15px; }
        
        .btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: 600;
        }

        .btn:active { background: #b91c1c; }
        .btn-secondary { background: #3b82f6; }
        .btn-success { background: #10b981; }
        .btn-small { padding: 6px 12px; width: auto; font-size: 14px; }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #dc2626;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
        }

        .logo { text-align: center; font-size: 64px; margin-bottom: 20px; }
        
        .nav-btn {
            display: block;
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .nav-btn:active, .nav-btn.active { background: #f3f4f6; font-weight: 600; }
        
        .item {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .del-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .hidden { display: none !important; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; overflow-x: auto; display: block; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
        th { background: #f9fafb; font-weight: 600; position: sticky; top: 0; }
        
        .podium { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            margin: 30px 0; 
            flex-wrap: wrap; 
        }
        
        .podium-item { 
            text-align: center; 
            background: white; 
            padding: 20px; 
            border-radius: 12px; 
            min-width: 140px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number { font-size: 32px; font-weight: bold; }
        .stat-label { font-size: 13px; opacity: 0.9; margin-top: 5px; }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            background: #e5e7eb;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
            font-weight: 600;
        }

        .tab.active { background: #dc2626; color: white; }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .card { padding: 15px; }
            table { font-size: 14px; }
            th, td { padding: 8px; }
        }
    </style>
</head>
<body>
    <div id="app">Carregando...</div>

    <script>
        // ===== ARMAZENAMENTO =====
        const db = {
            get(k) { 
                try { 
                    const d = localStorage.getItem(k); 
                    return d ? JSON.parse(d) : null; 
                } catch(e) { 
                    return null; 
                } 
            },
            set(k, v) { 
                try { 
                    localStorage.setItem(k, JSON.stringify(v)); 
                } catch(e) {
                    console.error('Erro ao salvar:', e);
                } 
            }
        };

        // ===== ESTADO GLOBAL =====
        let app = {
            user: db.get('user'),
            data: db.get('data') || {
                name: 'Campeonato de Kart Rental',
                pilots: [],
                karts: [],
                stages: [],
                points: {
                    qualifying: [10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
                    battery: [25, 22, 20, 18, 16, 14, 12, 10, 8, 6, 4, 2],
                    bestLapBonus: 1,
                    bestQualifyBonus: 1
                }
            },
            page: 'home',
            editingStage: null
        };

        function save() { 
            db.set('data', app.data); 
            db.set('user', app.user); 
        }

        function generateId() {
            return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // ===== AUTENTICA√á√ÉO =====
        function login(e) {
            e.preventDefault();
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if (u === 'admin' && p === 'admin123') {
                app.user = { name: 'admin', role: 'admin' };
                save();
                render();
            } else {
                alert('Login incorreto!');
            }
        }

        function logout() { 
            app.user = null; 
            save(); 
            render(); 
        }

        function goto(p) { 
            app.page = p; 
            app.editingStage = null;
            render(); 
        }

        // ===== PILOTOS =====
        function addPilot(e) {
            e.preventDefault();
            const name = document.getElementById('pname').value;
            const num = document.getElementById('pnum').value;
            const cat = document.getElementById('pcat').value;
            app.data.pilots.push({ 
                id: generateId(), 
                name, 
                number: num || null,
                cat 
            });
            save();
            render();
        }

        function delPilot(id) {
            if (confirm('Excluir piloto?')) {
                app.data.pilots = app.data.pilots.filter(p => p.id != id);
                save();
                render();
            }
        }

        // ===== KARTS =====
        function addKart(e) {
            e.preventDefault();
            const num = document.getElementById('knum').value;
            app.data.karts.push({ id: generateId(), num });
            save();
            render();
        }

        function delKart(id) {
            app.data.karts = app.data.karts.filter(k => k.id != id);
            save();
            render();
        }

        function draw() {
            const cat = document.getElementById('dcat').value;
            const pilots = app.data.pilots.filter(p => p.cat === cat);
            const karts = [...app.data.karts].sort(() => Math.random() - 0.5);
            
            if (pilots.length === 0) return alert('Sem pilotos nesta categoria!');
            if (karts.length < pilots.length) return alert('Sem karts suficientes!');

            let html = '<div class="card"><h3>Resultado - ' + cat + '</h3>';
            pilots.forEach((p, i) => {
                html += '<div class="item"><strong>' + (i+1) + '. ' + p.name + '</strong><span style="background:#dc2626;color:white;padding:5px 15px;border-radius:20px;">Kart ' + karts[i].num + '</span></div>';
            });
            html += '</div>';
            document.getElementById('dresult').innerHTML = html;
        }

        // ===== ETAPAS =====
        function createStage(e) {
            e.preventDefault();
            const stage = {
                id: generateId(),
                name: document.getElementById('sname').value,
                date: document.getElementById('sdate').value,
                qualifying: {},
                battery1: {},
                battery2: {}
            };
            
            // Inicializar categorias
            ['Dinos', 'Baby Dinos'].forEach(cat => {
                stage.qualifying[cat] = [];
                stage.battery1[cat] = [];
                stage.battery2[cat] = [];
            });

            app.data.stages.push(stage);
            save();
            render();
        }

        function delStage(id) {
            if (confirm('Excluir etapa?')) {
                app.data.stages = app.data.stages.filter(s => s.id != id);
                save();
                render();
            }
        }

        function editStage(id) {
            app.editingStage = id;
            app.page = 'edit-stage';
            render();
        }

        function saveQualifying(e) {
            e.preventDefault();
            const stageId = app.editingStage;
            const stage = app.data.stages.find(s => s.id === stageId);
            if (!stage) return;

            const cat = document.getElementById('qcat').value;
            const results = [];

            app.data.pilots.filter(p => p.cat === cat).forEach(pilot => {
                const time = document.getElementById('qtime-' + pilot.id).value;
                if (time && time.trim()) {
                    results.push({
                        pilotId: pilot.id,
                        pilotName: pilot.name,
                        time: time,
                        points: 0,
                        position: 0
                    });
                }
            });

            // Ordenar por tempo e atribuir posi√ß√µes
            results.sort((a, b) => {
                const timeA = parseFloat(a.time.replace(':', '').replace(',', '.'));
                const timeB = parseFloat(b.time.replace(':', '').replace(',', '.'));
                return timeA - timeB;
            });

            results.forEach((r, i) => {
                r.position = i + 1;
                r.points = app.data.points.qualifying[i] || 0;
            });

            stage.qualifying[cat] = results;
            save();
            alert('Qualifying salvo!');
            render();
        }

        function saveBattery(e, batteryNum) {
            e.preventDefault();
            const stageId = app.editingStage;
            const stage = app.data.stages.find(s => s.id === stageId);
            if (!stage) return;

            const cat = document.getElementById('bcat' + batteryNum).value;
            const batteryKey = 'battery' + batteryNum;
            const results = [];

            app.data.pilots.filter(p => p.cat === cat).forEach(pilot => {
                const pos = document.getElementById('bpos' + batteryNum + '-' + pilot.id).value;
                const pen = document.getElementById('bpen' + batteryNum + '-' + pilot.id).value;
                const dcl = document.getElementById('bdcl' + batteryNum + '-' + pilot.id).checked;
                const dnp = document.getElementById('bdnp' + batteryNum + '-' + pilot.id).checked;

                if (pos || dcl || dnp) {
                    const position = parseInt(pos) || 0;
                    const penalties = parseInt(pen) || 0;
                    let points = 0;

                    if (!dcl && !dnp && position > 0) {
                        points = app.data.points.battery[position - 1] || 0;
                    }

                    results.push({
                        pilotId: pilot.id,
                        pilotName: pilot.name,
                        position: position,
                        points: points,
                        penalties: penalties,
                        disqualified: dcl,
                        didNotParticipate: dnp
                    });
                }
            });

            stage[batteryKey][cat] = results;
            save();
            alert('Bateria ' + batteryNum + ' salva!');
            render();
        }

        // ===== C√ÅLCULO DE CLASSIFICA√á√ÉO =====
        function calculateStandings(category) {
            const pilots = app.data.pilots.filter(p => p.cat === category);
            
            return pilots.map(pilot => {
                let totalPoints = 0;
                const stageResults = [];

                app.data.stages.forEach(stage => {
                    let stagePoints = 0;
                    let bonusPoints = 0;
                    let penalties = 0;

                    // Qualifying
                    const qResult = (stage.qualifying[category] || []).find(q => q.pilotId === pilot.id);
                    if (qResult) {
                        stagePoints += qResult.points || 0;
                        
                        // B√¥nus melhor tempo qualifying
                        const allQ = stage.qualifying[category] || [];
                        if (allQ.length > 0 && allQ[0].pilotId === pilot.id) {
                            bonusPoints += app.data.points.bestQualifyBonus;
                        }
                    }

                    // Bateria 1
                    const b1Result = (stage.battery1[category] || []).find(b => b.pilotId === pilot.id);
                    if (b1Result) {
                        if (!b1Result.disqualified && !b1Result.didNotParticipate) {
                            stagePoints += b1Result.points || 0;
                            penalties += b1Result.penalties || 0;
                        }
                    }

                    // Bateria 2
                    const b2Result = (stage.battery2[category] || []).find(b => b.pilotId === pilot.id);
                    if (b2Result) {
                        if (!b2Result.disqualified && !b2Result.didNotParticipate) {
                            stagePoints += b2Result.points || 0;
                            penalties += b2Result.penalties || 0;
                        }
                    }

                    const finalPoints = stagePoints + bonusPoints - penalties;
                    totalPoints += finalPoints;

                    stageResults.push({
                        stageName: stage.name,
                        points: finalPoints,
                        rawPoints: stagePoints,
                        bonusPoints: bonusPoints,
                        penalties: penalties
                    });
                });

                return {
                    pilotId: pilot.id,
                    pilotName: pilot.name,
                    pilotNumber: pilot.number,
                    category: pilot.cat,
                    totalPoints: totalPoints,
                    stageResults: stageResults
                };
            }).sort((a, b) => b.totalPoints - a.totalPoints);
        }

        function showStandings(cat) {
            const standings = calculateStandings(cat);
            
            let html = '';

            // P√≥dio
            if (standings.length >= 3) {
                html += '<div class="podium">';
                
                // 2¬∫ lugar
                if (standings[1]) {
                    html += `<div class="podium-item">
                        <div style="font-size:48px;">ü•à</div>
                        <div style="font-size:24px;font-weight:bold;">2¬∫</div>
                        <div style="font-weight:600;margin:10px 0;">${standings[1].pilotName}</div>
                        <div style="font-size:20px;color:#666;">${standings[1].totalPoints} pts</div>
                    </div>`;
                }
                
                // 1¬∫ lugar
                if (standings[0]) {
                    html += `<div class="podium-item" style="transform:scale(1.1);">
                        <div style="font-size:64px;">ü•á</div>
                        <div style="font-size:32px;font-weight:bold;color:#dc2626;">1¬∫</div>
                        <div style="font-weight:bold;font-size:18px;margin:10px 0;">${standings[0].pilotName}</div>
                        <div style="font-size:24px;color:#dc2626;font-weight:bold;">${standings[0].totalPoints} pts</div>
                    </div>`;
                }
                
                // 3¬∫ lugar
                if (standings[2]) {
                    html += `<div class="podium-item">
                        <div style="font-size:40px;">ü•â</div>
                        <div style="font-size:20px;font-weight:bold;">3¬∫</div>
                        <div style="font-weight:600;margin:10px 0;">${standings[2].pilotName}</div>
                        <div style="font-size:18px;color:#666;">${standings[2].totalPoints} pts</div>
                    </div>`;
                }
                
                html += '</div>';
            }

            // Tabela
            html += '<div style="overflow-x:auto;"><table><thead><tr>';
            html += '<th>Pos</th><th>Piloto</th><th>Total</th>';
            app.data.stages.forEach(s => {
                html += '<th>' + s.name + '</th>';
            });
            html += '</tr></thead><tbody>';

            standings.forEach((s, i) => {
                html += '<tr>';
                html += '<td style="font-weight:bold;font-size:18px;">' + (i+1) + '¬∫</td>';
                html += '<td style="font-weight:600;">' + s.pilotName + (s.pilotNumber ? ' #' + s.pilotNumber : '') + '</td>';
                html += '<td style="font-weight:bold;color:#dc2626;font-size:18px;">' + s.totalPoints + '</td>';
                
                s.stageResults.forEach(sr => {
                    html += '<td>';
                    html += '<div style="font-weight:600;">' + sr.points + '</div>';
                    if (sr.bonusPoints > 0) {
                        html += '<div style="font-size:11px;color:green;">+' + sr.bonusPoints + '</div>';
                    }
                    if (sr.penalties > 0) {
                        html += '<div style="font-size:11px;color:red;">-' + sr.penalties + '</div>';
                    }
                    html += '</td>';
                });
                
                html += '</tr>';
            });

            html += '</tbody></table></div>';

            document.getElementById('sresult').innerHTML = html;
        }

        // ===== P√ÅGINAS =====
        function pageLogin() {
            return `<div class="login-container">
                <div class="login-card">
                    <div class="logo">üèéÔ∏è</div>
                    <h1 style="text-align:center;margin-bottom:10px;">Campeonato de Kart</h1>
                    <p style="text-align:center;color:#666;margin-bottom:30px;">Sistema de Gerenciamento</p>
                    <form onsubmit="login(event)">
                        <input type="text" id="user" placeholder="Usu√°rio" required>
                        <input type="password" id="pass" placeholder="Senha" required>
                        <button type="submit" class="btn">Entrar</button>
                    </form>
                    <div style="margin-top:20px;padding:15px;background:#f9fafb;border-radius:8px;">
                        <p style="text-align:center;color:#666;font-size:14px;">
                            <strong>Login Admin:</strong><br>
                            Usu√°rio: <strong>admin</strong><br>
                            Senha: <strong>admin123</strong>
                        </p>
                    </div>
                </div>
            </div>`;
        }

        function pageHome() {
            return `<div class="card">
                <h1>üèéÔ∏è ${app.data.name}</h1>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-number">${app.data.pilots.length}</div>
                        <div class="stat-label">Pilotos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${app.data.stages.length}</div>
                        <div class="stat-label">Etapas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${app.data.karts.length}</div>
                        <div class="stat-label">Karts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">2</div>
                        <div class="stat-label">Categorias</div>
                    </div>
                </div>
            </div>`;
        }

        function pagePilots() {
            const dinos = app.data.pilots.filter(p => p.cat === 'Dinos');
            const baby = app.data.pilots.filter(p => p.cat === 'Baby Dinos');
            
            return `<div class="card">
                <h2>üë• Gerenciar Pilotos</h2>
                <form onsubmit="addPilot(event)">
                    <div class="form-group">
                        <label>Nome do Piloto</label>
                        <input type="text" id="pname" placeholder="Nome completo" required>
                    </div>
                    <div class="form-group">
                        <label>N√∫mero (opcional)</label>
                        <input type="text" id="pnum" placeholder="Ex: 77">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="pcat" required>
                            <option value="Dinos">Dinos (Senior)</option>
                            <option value="Baby Dinos">Baby Dinos (Graduados)</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-success">‚ûï Adicionar Piloto</button>
                </form>

                <h3 style="margin-top:30px;">Dinos - Senior (${dinos.length})</h3>
                ${dinos.length === 0 ? '<p style="color:#666;">Nenhum piloto cadastrado</p>' : ''}
                ${dinos.map(p => `
                    <div class="item">
                        <div>
                            <strong>${p.name}</strong>
                            ${p.number ? '<span style="color:#666;"> - #' + p.number + '</span>' : ''}
                        </div>
                        <button class="del-btn" onclick="delPilot('${p.id}')">Excluir</button>
                    </div>
                `).join('')}

                <h3 style="margin-top:30px;">Baby Dinos - Graduados (${baby.length})</h3>
                ${baby.length === 0 ? '<p style="color:#666;">Nenhum piloto cadastrado</p>' : ''}
                ${baby.map(p => `
                    <div class="item">
                        <div>
                            <strong>${p.name}</strong>
                            ${p.number ? '<span style="color:#666;"> - #' + p.number + '</span>' : ''}
                        </div>
                        <button class="del-btn" onclick="delPilot('${p.id}')">Excluir</button>
                    </div>
                `).join('')}
            </div>`;
        }

        function pageKarts() {
            return `<div class="card">
                <h2>üé≤ Sorteio de Karts</h2>
                
                <h3>Cadastrar Karts</h3>
                <form onsubmit="addKart(event)">
                    <input type="text" id="knum" placeholder="N√∫mero do Kart" required>
                    <button type="submit" class="btn btn-success">‚ûï Adicionar Kart</button>
                </form>

                <h3 style="margin-top:20px;">Karts Cadastrados (${app.data.karts.length})</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:20px;">
                    ${app.data.karts.map(k => `
                        <div style="background:#f3f4f6;padding:10px;border-radius:8px;text-align:center;position:relative;">
                            <strong>Kart ${k.num}</strong>
                            <button onclick="delKart('${k.id}')" style="position:absolute;top:5px;right:5px;background:#ef4444;color:white;border:none;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:14px;">√ó</button>
                        </div>
                    `).join('')}
                </div>

                <h3>Realizar Sorteio</h3>
                <select id="dcat">
                    <option value="Dinos">Dinos (Senior)</option>
                    <option value="Baby Dinos">Baby Dinos (Graduados)</option>
                </select>
                <button class="btn" onclick="draw()">üé≤ Sortear Karts</button>
                <div id="dresult"></div>
            </div>`;
        }

        function pageStages() {
            return `<div class="card">
                <h2>üìÖ Etapas do Campeonato</h2>
                
                <form onsubmit="createStage(event)">
                    <div class="form-group">
                        <label>Nome da Etapa</label>
                        <input type="text" id="sname" placeholder="Ex: 1¬™ Etapa" required>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="sdate" required>
                    </div>
                    <button type="submit" class="btn btn-success">‚ûï Criar Etapa</button>
                </form>

                <h3 style="margin-top:30px;">Etapas Cadastradas (${app.data.stages.length})</h3>
                ${app.data.stages.length === 0 ? '<p style="color:#666;">Nenhuma etapa cadastrada</p>' : ''}
                ${app.data.stages.map(s => `
                    <div class="item">
                        <div>
                            <strong>${s.name}</strong>
                            <span style="color:#666;"> - ${new Date(s.date + 'T00:00:00').toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button class="btn-secondary btn-small" onclick="editStage('${s.id}')">‚úèÔ∏è Editar</button>
                            <button class="del-btn" onclick="delStage('${s.id}')">Excluir</button>
                        </div>
                    </div>
                `).join('')}
            </div>`;
        }

        function pageEditStage() {
            const stage = app.data.stages.find(s => s.id === app.editingStage);
            if (!stage) {
                app.page = 'stages';
                render();
                return '';
            }

            return `<div class="card">
                <h2>‚úèÔ∏è Editar: ${stage.name}</h2>
                <p style="color:#666;margin-bottom:20px;">${new Date(stage.date + 'T00:00:00').toLocaleDateString('pt-BR')}</p>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('qualifying')">Qualifying</button>
                    <button class="tab" onclick="showTab('battery1')">1¬™ Bateria</button>
                    <button class="tab" onclick="showTab('battery2')">2¬™ Bateria</button>
                </div>

                <!-- Qualifying -->
                <div id="tab-qualifying">
                    <h3>Qualifying (2 voltas)</h3>
                    <form onsubmit="saveQualifying(event)">
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="qcat">
                                <option value="Dinos">Dinos (Senior)</option>
                                <option value="Baby Dinos">Baby Dinos (Graduados)</option>
                            </select>
                        </div>
                        <p style="font-size:14px;color:#666;margin-bottom:15px;">
                            Digite o melhor tempo de cada piloto no formato MM:SS.mmm (ex: 1:23.456) ou SS.mmm (ex: 58.123)
                        </p>
                        ${renderQualifyingForm()}
                        <button type="submit" class="btn btn-success">üíæ Salvar Qualifying</button>
                    </form>
                </div>

                <!-- Bateria 1 -->
                <div id="tab-battery1" class="hidden">
                    <h3>1¬™ Bateria (10 minutos)</h3>
                    <form onsubmit="saveBattery(event, 1)">
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="bcat1">
                                <option value="Dinos">Dinos (Senior)</option>
                                <option value="Baby Dinos">Baby Dinos (Graduados)</option>
                            </select>
                        </div>
                        ${renderBatteryForm(1)}
                        <button type="submit" class="btn btn-success">üíæ Salvar 1¬™ Bateria</button>
                    </form>
                </div>

                <!-- Bateria 2 -->
                <div id="tab-battery2" class="hidden">
                    <h3>2¬™ Bateria (10 minutos)</h3>
                    <form onsubmit="saveBattery(event, 2)">
                        <div class="form-group">
                            <label>Categoria</label>
                            <select id="bcat2">
                                <option value="Dinos">Dinos (Senior)</option>
                                <option value="Baby Dinos">Baby Dinos (Graduados)</option>
                            </select>
                        </div>
                        ${renderBatteryForm(2)}
                        <button type="submit" class="btn btn-success">üíæ Salvar 2¬™ Bateria</button>
                    </form>
                </div>

                <button class="btn btn-secondary" onclick="goto('stages')" style="margin-top:20px;">‚Üê Voltar para Etapas</button>
            </div>`;
        }

        function renderQualifyingForm() {
            let html = '';
            const dinosPilots = app.data.pilots.filter(p => p.cat === 'Dinos');
            const babyPilots = app.data.pilots.filter(p => p.cat === 'Baby Dinos');

            ['Dinos', 'Baby Dinos'].forEach(cat => {
                const pilots = cat === 'Dinos' ? dinosPilots : babyPilots;
                
                pilots.forEach(pilot => {
                    html += `<div class="form-group">
                        <label>${pilot.name} ${pilot.number ? '#' + pilot.number : ''}</label>
                        <input type="text" id="qtime-${pilot.id}" placeholder="Ex: 1:23.456 ou 58.123">
                    </div>`;
                });
            });

            return html;
        }

        function renderBatteryForm(batteryNum) {
            let html = '';
            const dinosPilots = app.data.pilots.filter(p => p.cat === 'Dinos');
            const babyPilots = app.data.pilots.filter(p => p.cat === 'Baby Dinos');

            ['Dinos', 'Baby Dinos'].forEach(cat => {
                const pilots = cat === 'Dinos' ? dinosPilots : babyPilots;
                
                pilots.forEach(pilot => {
                    html += `<div style="background:#f9fafb;padding:15px;border-radius:8px;margin-bottom:10px;">
                        <strong style="display:block;margin-bottom:10px;">${pilot.name} ${pilot.number ? '#' + pilot.number : ''}</strong>
                        <div class="grid-2">
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:13px;">Posi√ß√£o</label>
                                <input type="number" id="bpos${batteryNum}-${pilot.id}" min="1" placeholder="1¬∫, 2¬∫, 3¬∫...">
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:13px;">Penalidades</label>
                                <input type="number" id="bpen${batteryNum}-${pilot.id}" min="0" value="0">
                            </div>
                        </div>
                        <div style="display:flex;gap:15px;margin-top:10px;">
                            <div class="checkbox-group">
                                <input type="checkbox" id="bdcl${batteryNum}-${pilot.id}">
                                <label style="margin:0;font-weight:normal;font-size:14px;">Desclassificado</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="bdnp${batteryNum}-${pilot.id}">
                                <label style="margin:0;font-weight:normal;font-size:14px;">N√£o Participou</label>
                            </div>
                        </div>
                    </div>`;
                });
            });

            return html;
        }

        function pageStandings() {
            return `<div class="card">
                <h2>üèÜ Classifica√ß√£o Geral</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="showStandings('Dinos')">Dinos (Senior)</button>
                    <button class="tab" onclick="showStandings('Baby Dinos')">Baby Dinos (Graduados)</button>
                </div>

                <div id="sresult" style="margin-top:20px;"></div>
            </div>`;
        }

        function showTab(tabName) {
            ['qualifying', 'battery1', 'battery2'].forEach(t => {
                document.getElementById('tab-' + t).classList.add('hidden');
            });
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ===== RENDER PRINCIPAL =====
        function render() {
            const el = document.getElementById('app');
            if (!el) return;

            if (!app.user) {
                el.innerHTML = pageLogin();
                return;
            }

            let content = '';
            switch(app.page) {
                case 'home': content = pageHome(); break;
                case 'pilots': content = pagePilots(); break;
                case 'karts': content = pageKarts(); break;
                case 'stages': content = pageStages(); break;
                case 'edit-stage': content = pageEditStage(); break;
                case 'standings': content = pageStandings(); break;
                default: content = pageHome();
            }

            el.innerHTML = `<div class="container">
                <div class="card">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                        <div>
                            <h2 style="margin:0;">üèéÔ∏è ${app.data.name}</h2>
                            <p style="margin:5px 0 0 0;color:#666;font-size:14px;">Admin: ${app.user.name}</p>
                        </div>
                        <button class="btn del-btn" onclick="logout()" style="width:auto;padding:10px 20px;">Sair</button>
                    </div>
                </div>
                
                ${app.page !== 'edit-stage' ? `
                <div class="card">
                    <button class="nav-btn ${app.page==='home'?'active':''}" onclick="goto('home')">üè† In√≠cio</button>
                    <button class="nav-btn ${app.page==='standings'?'active':''}" onclick="goto('standings')">üèÜ Classifica√ß√£o</button>
                    <button class="nav-btn ${app.page==='pilots'?'active':''}" onclick="goto('pilots')">üë• Pilotos</button>
                    <button class="nav-btn ${app.page==='karts'?'active':''}" onclick="goto('karts')">üé≤ Sorteio de Karts</button>
                    <button class="nav-btn ${app.page==='stages'?'active':''}" onclick="goto('stages')">üìÖ Etapas</button>
                </div>
                ` : ''}
                
                ${content}
            </div>`;

            // Inicializar classifica√ß√£o se necess√°rio
            if (app.page === 'standings') {
                setTimeout(() => showStandings('Dinos'), 100);
            }
        }

        // ===== INICIALIZAR =====
        setTimeout(() => render(), 100);
    </script>
</body>
</html>
