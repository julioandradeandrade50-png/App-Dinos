<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#dc2626">
<title>üèéÔ∏è Campeonato de Kart</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#1a1a2e;min-height:100vh;padding-bottom:60px}
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%)}
.login-box{background:white;border-radius:24px;padding:40px 32px;max-width:440px;width:100%;box-shadow:0 30px 60px rgba(0,0,0,.5)}
.login-logo{text-align:center;margin-bottom:24px}
.login-logo .ico{font-size:80px;display:block;line-height:1}
.login-logo h1{font-size:22px;color:#1a1a2e;font-weight:900;margin-top:10px}
.login-logo p{font-size:13px;color:#888;margin-top:4px}
.lfield{margin-bottom:16px}
.lfield label{display:block;font-size:12px;font-weight:800;color:#555;margin-bottom:7px;text-transform:uppercase;letter-spacing:.6px}
.lfield input{width:100%;padding:13px 16px;border:2px solid #e5e7eb;border-radius:11px;font-size:16px;background:#fafafa}
.lfield input:focus{outline:none;border-color:#dc2626;background:white}
.btn-login{width:100%;padding:14px;background:linear-gradient(135deg,#dc2626,#991b1b);color:white;border:none;border-radius:12px;font-size:17px;font-weight:800;cursor:pointer;margin-top:10px;box-shadow:0 4px 14px rgba(220,38,38,.4)}
.login-creds{margin-top:20px;border-radius:12px;overflow:hidden;border:1px solid #f3f4f6}
.cred-row{display:flex;align-items:center;padding:13px 16px;gap:12px}
.cred-row.ca{background:#fff5f5;border-bottom:1px solid #f3f4f6}
.cred-row.cp{background:#eff6ff}
.cred-ico{font-size:22px;width:34px;text-align:center}
.cred-info strong{display:block;font-size:13px;color:#333}
.cred-info span{font-size:12px;color:#888}
.err{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:10px 14px;border-radius:10px;font-size:14px;margin-bottom:14px;text-align:center;display:none}
.wrap{max-width:1200px;margin:0 auto;padding:15px}
.hdr{background:linear-gradient(135deg,#1a1a2e,#0f3460);border-radius:16px;padding:16px 20px;margin-bottom:14px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px}
.hdr h2{color:white;font-size:17px;font-weight:900;margin:0}
.hdr p{color:rgba(255,255,255,.55);font-size:13px;margin:4px 0 0}
.rb{display:inline-block;padding:3px 11px;border-radius:20px;font-size:11px;font-weight:800;text-transform:uppercase;margin-right:6px}
.rb-a{background:#dc2626;color:white}
.rb-p{background:#3b82f6;color:white}
.btn-out{padding:8px 16px;background:rgba(255,255,255,.1);color:white;border:1px solid rgba(255,255,255,.2);border-radius:8px;cursor:pointer;font-size:13px;font-weight:600}
.nav{background:white;border-radius:14px;padding:10px;margin-bottom:14px;display:flex;flex-wrap:wrap;gap:5px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
.nb{flex:1;min-width:72px;padding:10px 5px;background:#f9fafb;border:none;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;color:#666;text-align:center;line-height:1.5}
.nb.active{background:#dc2626;color:white}
.nsep{width:100%;height:1px;background:#f3f4f6;margin:3px 0}
.nlbl{width:100%;font-size:10px;font-weight:800;color:#bbb;text-transform:uppercase;letter-spacing:.6px;padding:2px 4px}
.card{background:white;border-radius:14px;padding:20px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
.ct{font-size:18px;font-weight:900;color:#1a1a2e;margin-bottom:18px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:10px;margin-bottom:18px}
.stc{background:linear-gradient(135deg,#1a1a2e,#0f3460);color:white;padding:16px;border-radius:12px;text-align:center}
.stn{font-size:32px;font-weight:900;line-height:1}
.stl{font-size:11px;opacity:.75;margin-top:5px;font-weight:600}
.fsec{background:#f9fafb;border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid #f3f4f6}
.fsec h3{font-size:13px;font-weight:800;color:#444;margin-bottom:14px;text-transform:uppercase;letter-spacing:.5px}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.f label{display:block;font-size:11px;font-weight:800;color:#666;margin-bottom:5px;text-transform:uppercase;letter-spacing:.4px}
.f input,.f select,.f textarea{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;font-size:15px;background:white}
.f input:focus,.f select:focus{outline:none;border-color:#dc2626}
.f{margin-bottom:12px}
.btn{padding:12px 18px;border:none;border-radius:10px;font-size:14px;font-weight:800;cursor:pointer;width:100%;margin-top:8px}
.bg{background:#10b981;color:white}
.br{background:#dc2626;color:white}
.bb{background:#3b82f6;color:white}
.bw{background:#e5e7eb;color:#444}
.bsm{padding:7px 13px;font-size:13px;width:auto;margin:0}
.li{background:#f9fafb;border-radius:10px;padding:13px 16px;margin-bottom:7px;display:flex;justify-content:space-between;align-items:center;gap:10px;border:1px solid #f3f4f6}
.pnum{width:36px;height:36px;background:#dc2626;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:13px;flex-shrink:0}
.catd{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:800}
.cd{background:#fef3c7;color:#d97706}
.cb{background:#dbeafe;color:#2563eb}
.dbtn{padding:6px 12px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:7px;cursor:pointer;font-size:13px;font-weight:700}
.tabs{display:flex;gap:6px;margin-bottom:16px;overflow-x:auto;padding-bottom:3px}
.tab{padding:9px 16px;border:none;border-radius:8px;cursor:pointer;white-space:nowrap;font-size:13px;font-weight:700;background:#f3f4f6;color:#666}
.tab.active{background:#dc2626;color:white}
.tw{overflow-x:auto;border-radius:10px;border:1px solid #f3f4f6}
table{width:100%;border-collapse:collapse;min-width:280px}
th{background:#f9fafb;padding:11px 13px;text-align:left;font-size:12px;font-weight:800;color:#555;border-bottom:2px solid #f3f4f6;white-space:nowrap;text-transform:uppercase;letter-spacing:.3px}
td{padding:11px 13px;border-bottom:1px solid #f9fafb;font-size:14px;white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:#fafafa}
.pb{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;margin:auto}
.p1{background:#fef3c7;color:#d97706}.p2{background:#f3f4f6;color:#6b7280}.p3{background:#fdf2e9;color:#c2682e}
.ptb{font-size:19px;font-weight:900;color:#dc2626}
.podium{display:flex;justify-content:center;align-items:flex-end;gap:10px;padding:16px 0 28px;flex-wrap:wrap}
.pp{text-align:center;border-radius:14px;padding:16px 12px;min-width:105px}
.pp1{background:linear-gradient(135deg,#fef9c3,#fde047);order:2;padding-bottom:28px}
.pp2{background:linear-gradient(135deg,#f3f4f6,#e5e7eb);order:1;padding-bottom:18px}
.pp3{background:linear-gradient(135deg,#fdf2e9,#f5c5a3);order:3;padding-bottom:8px}
.pm{font-size:34px}.pp-pos{font-size:22px;font-weight:900}
.pp1 .pp-pos{color:#ca8a04}.pp2 .pp-pos{color:#6b7280}.pp3 .pp-pos{color:#c2682e}
.ppn{font-weight:800;font-size:13px;margin:5px 0 4px;color:#1a1a2e}.ppp{font-size:15px;font-weight:900}
.pp1 .ppp{color:#ca8a04}
.stg-card{border:2px solid #f3f4f6;border-radius:12px;padding:16px;margin-bottom:10px;cursor:pointer}
.stg-card.open{border-color:#dc2626;background:#fff8f8}
.stg-hdr{display:flex;justify-content:space-between;align-items:center;gap:10px}
.stg-name{font-weight:900;font-size:15px;color:#1a1a2e}
.stg-date{font-size:13px;color:#888;margin-top:3px}
.stg-body{margin-top:14px;border-top:2px solid #f3f4f6;padding-top:14px}
.sectit{font-size:12px;font-weight:900;color:#1a1a2e;margin:14px 0 8px;padding-bottom:5px;border-bottom:2px solid #f3f4f6;text-transform:uppercase;letter-spacing:.5px}
.krow{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-radius:8px;background:white;border:1px solid #f3f4f6;margin-bottom:6px}
.ktag{background:#1a1a2e;color:white;padding:5px 14px;border-radius:20px;font-weight:800;font-size:13px}
.brow{display:flex;align-items:center;gap:14px;padding:12px 16px;background:#f0fdf4;border-radius:10px;margin-bottom:8px;border:1px solid #bbf7d0}
.btime{font-size:22px;font-weight:900;color:#16a34a;font-family:monospace}
.bpilot{font-size:14px;font-weight:700;color:#1a1a2e}
.bstage{font-size:12px;color:#666;margin-top:2px}
.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-top:10px}
.pi{padding:11px;border-radius:10px;text-align:center;font-size:13px;font-weight:700;line-height:1.4}
.pres{background:#f0fdf4;color:#16a34a;border:1px solid #bbf7d0}
.abs{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
.dcl{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa}
.acc{border:1px solid #f3f4f6;border-radius:11px;margin-bottom:8px;overflow:hidden}
.ach{padding:13px 16px;background:#f9fafb;cursor:pointer;font-weight:800;display:flex;justify-content:space-between;align-items:center;user-select:none;font-size:14px}
.acb{padding:16px;display:none}
.acb.open{display:block}
.info{padding:12px 14px;border-radius:10px;font-size:13px;margin-bottom:12px;line-height:1.5}
.ib{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
.ig{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534}
.iy{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.readonly-bar{background:linear-gradient(135deg,#1e40af,#1d4ed8);color:white;border-radius:10px;padding:10px 16px;font-size:13px;font-weight:700;text-align:center;margin-bottom:14px}
@media(max-width:600px){.frow{grid-template-columns:1fr}.podium{gap:8px}.pp{min-width:95px}.hdr h2{font-size:15px}td,th{padding:8px 10px;font-size:13px}}


.pts-breakdown{display:inline-block;padding:4px 8px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;font-size:11px;font-weight:700;color:#1e40af;margin-left:6px}
.penalty-note{display:block;margin-top:4px;padding:6px 10px;background:#fffbeb;border-left:3px solid #f59e0b;font-size:12px;color:#92400e;border-radius:4px}
.dcl-note{display:block;margin-top:4px;padding:6px 10px;background:#fef2f2;border-left:3px solid #dc2626;font-size:12px;color:#991b1b;border-radius:4px}
/* ===== DASHBOARD P√öBLICO ===== */
.public-wrap{background:linear-gradient(135deg,#1a1a2e,#16213e);min-height:100vh;padding:20px 0}
.public-header{background:rgba(255,255,255,.1);backdrop-filter:blur(10px);border-radius:16px;padding:20px 30px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}
.public-header h1{color:white;font-size:24px;font-weight:900;margin:0;display:flex;align-items:center;gap:12px}
.public-header .logo-small{width:50px;height:50px;border-radius:10px;object-fit:cover}
.public-nav{display:flex;gap:8px;flex-wrap:wrap}
.public-nav-btn{padding:10px 18px;background:rgba(255,255,255,.15);color:white;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:700;transition:all .2s}
.public-nav-btn:hover{background:rgba(255,255,255,.25)}
.public-nav-btn.active{background:#dc2626}
.public-card{background:white;border-radius:16px;padding:25px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,.15)}
.public-title{font-size:22px;font-weight:900;color:#1a1a2e;margin-bottom:20px;display:flex;align-items:center;gap:10px}
.dash-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:25px}
.dash-stat{background:linear-gradient(135deg,#dc2626,#991b1b);color:white;padding:25px;border-radius:14px;text-align:center;box-shadow:0 4px 12px rgba(220,38,38,.3)}
.dash-stat-num{font-size:42px;font-weight:900;line-height:1;margin-bottom:8px}
.dash-stat-label{font-size:13px;opacity:.9;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.public-footer{text-align:center;padding:30px 20px;color:rgba(255,255,255,.6);font-size:13px}
</style>
</head>
<body>
<div id="APP">Carregando...</div>
<script>
// ====================== BANCO ======================
const DB={get(k){try{const d=localStorage.getItem(k);return d?JSON.parse(d):null}catch(e){return null}},set(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}};

// ====================== CREDENCIAIS FIXAS ======================
const CREDS={admin:{u:'admin',p:'admin123'},pilot:{u:'piloto',p:'piloto123'}};

// ====================== ESTADO ======================
// Detectar modo p√∫blico via URL
const urlParams=new URLSearchParams(window.location.search);
const isPublicView=urlParams.get('view')==='public';

let G={
  user:isPublicView?{role:'public',name:'P√∫blico'}:DB.get('kart_sess'),
  page:'standings',
  isPublic:isPublicView,
  editStageId:null,editTab:'draw',editCat:'Dinos',
  viewCat:'Dinos',standCat:'Dinos',openStageId:null,
  data:DB.get('kart_data')||{
    name:'Campeonato de Kart Rental',regulation:'',partners:[],
    logoChampionship:'',partnerLogos:[],
    pilots:[],karts:[],stages:[],
    points:{qualifying:[10,9,8,7,6,5,4,3,2,1],battery:[25,22,20,18,16,14,12,10,8,6,4,2],bestLapBonus:1,bestQualifyBonus:1}
  }
};
function save(){DB.set('kart_data',G.data);DB.set('kart_sess',G.user)}
function uid(){return 'id'+Date.now()+Math.random().toString(36).substr(2,6)}

// ====================== AUTH ======================
function doLogin(e){
  e.preventDefault();
  const u=document.getElementById('lU').value.trim().toLowerCase();
  const p=document.getElementById('lP').value;
  if(u===CREDS.admin.u&&p===CREDS.admin.p){G.user={role:'admin',name:'Administrador'};G.page='home';save();render();}
  else if(u===CREDS.pilot.u&&p===CREDS.pilot.p){G.user={role:'pilot',name:'Piloto'};G.page='standings';save();render();}
  else{const el=document.getElementById('lerr');if(el){el.textContent='Usu√°rio ou senha incorretos!';el.style.display='block';}}
}
function logout(){G.user=null;DB.set('kart_sess',null);render()}
function goto(p){G.page=p;G.editStageId=null;render()}


// ====================== LOGOS ======================
function uploadChampLogo(e){
  const file=e.target.files[0];if(!file)return;
  if(!file.type.startsWith('image/'))return alert('Selecione uma imagem v√°lida!');
  if(file.size>500000)return alert('Imagem muito grande! Max 500KB');
  const reader=new FileReader();
  reader.onload=ev=>{G.data.logoChampionship=ev.target.result;save();alert('‚úÖ Logo do campeonato salva!');render();};
  reader.readAsDataURL(file);
}
function removeChampLogo(){if(!confirm('Remover logo do campeonato?'))return;G.data.logoChampionship='';save();render();}
function addPartnerLogo(e){
  e.preventDefault();
  const name=document.getElementById('plName').value.trim();
  const file=document.getElementById('plFile').files[0];
  if(!name)return alert('Digite o nome do parceiro!');
  if(!file)return alert('Selecione uma imagem!');
  if(!file.type.startsWith('image/'))return alert('Arquivo deve ser uma imagem!');
  if(file.size>300000)return alert('Imagem muito grande! Max 300KB');
  const reader=new FileReader();
  reader.onload=ev=>{
    G.data.partnerLogos.push({id:uid(),name,logo:ev.target.result});
    save();alert('‚úÖ Logo do parceiro adicionada!');render();
  };
  reader.readAsDataURL(file);
}
function delPartnerLogo(id){if(!confirm('Remover logo?'))return;G.data.partnerLogos=G.data.partnerLogos.filter(p=>p.id!==id);save();render();}



function getCatLabel(cat){return cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS';}

// ===== FUN√á√ïES AUXILIARES PARA INTERFACE =====
function updatePtsPreview(bn,pid){
  const pos=parseInt(document.getElementById('bp'+bn+'_'+pid).value)||0;
  const extra=parseInt(document.getElementById('be'+bn+'_'+pid).value)||0;
  const pen=parseInt(document.getElementById('bn'+bn+'_'+pid).value)||0;
  const base=pos>0?(G.data.points.battery[pos-1]||0):0;
  const total=Math.max(0,base+extra-pen);
  // Atualizar preview seria ideal, mas por simplicidade deixamos para salvar
}
function toggleDcl(bn,pid){
  const checked=document.getElementById('bd'+bn+'_'+pid).checked;
  const el=document.getElementById('dclr'+bn+'_'+pid);
  if(el)el.style.display=checked?'block':'none';
}


// Retrocompatibilidade: converter dados antigos para novo formato
function ensureDataCompat(){
  G.data.stages.forEach(stage=>{
    ['battery1','battery2'].forEach(bk=>{
      ['Dinos','Baby Dinos'].forEach(cat=>{
        const catLabel=cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS';
        if(stage[bk]&&stage[bk][cat]){
          stage[bk][cat]=stage[bk][cat].map(r=>{
            if(!r.pointsBase&&r.points){
              return {...r,pointsBase:r.points,pointsExtra:0,pointsTotal:r.points,penaltyReason:'',disqualificationReason:''};
            }
            return r;
          });
        }
      });
    });
  });
}

// ====================== PILOTOS ======================
function addPilot(e){
  e.preventDefault();
  const name=document.getElementById('pN').value.trim();
  const num=document.getElementById('pNm').value.trim();
  const cat=document.getElementById('pC').value;
  if(!name)return;
  G.data.pilots.push({id:uid(),name,number:num||null,cat});
  save();render();
}
function delPilot(id){if(!confirm('Excluir piloto?'))return;G.data.pilots=G.data.pilots.filter(p=>p.id!==id);save();render();}

// ====================== KARTS ======================
function addKart(e){
  e.preventDefault();
  const num=document.getElementById('kN').value.trim();
  if(!num)return;
  if(G.data.karts.find(k=>k.num===num))return alert('Kart '+num+' ja cadastrado!');
  G.data.karts.push({id:uid(),num});save();render();
}
function delKart(id){G.data.karts=G.data.karts.filter(k=>k.id!==id);save();render();}

// ====================== ETAPAS ======================
function addStage(e){
  e.preventDefault();
  const name=document.getElementById('sN').value.trim();
  const date=document.getElementById('sD').value;
  G.data.stages.push({id:uid(),name,date,kartDraw:{'Dinos':[],'Baby Dinos':[]},qualifying:{'Dinos':[],'Baby Dinos':[]},battery1:{'Dinos':[],'Baby Dinos':[]},battery2:{'Dinos':[],'Baby Dinos':[]}});
  save();render();
}
function delStage(id){if(!confirm('Excluir etapa?'))return;G.data.stages=G.data.stages.filter(s=>s.id!==id);save();render();}
function openEdit(id){G.editStageId=id;G.editTab='draw';G.editCat='Dinos';G.page='edit';render();}
function setTab(t){G.editTab=t;render()}
function setCat(c){G.editCat=c;render()}

// ====================== SORTEIO (arquivado) ======================
function doDraw(e){
  e.preventDefault();
  const cat=G.editCat;
  const stage=G.data.stages.find(s=>s.id===G.editStageId);
  if(!stage)return;
  const pilots=G.data.pilots.filter(p=>p.cat===cat);
  if(!pilots.length)return alert('Nenhum piloto nesta categoria!');
  const karts=[...G.data.karts].sort(()=>Math.random()-.5);
  if(karts.length<pilots.length)return alert('Karts insuficientes!');
  if(stage.kartDraw[cat]&&stage.kartDraw[cat].length>0){if(!confirm('Ja existe sorteio para '+cat+'. Refazer?'))return;}
  stage.kartDraw[cat]=pilots.map((p,i)=>({pilotId:p.id,pilotName:p.name,pilotNumber:p.number,kartNum:karts[i].num}));
  save();alert('Sorteio arquivado!');render();
}

// ====================== QUALIFYING ======================
function saveQ(e){
  e.preventDefault();
  const stage=G.data.stages.find(s=>s.id===G.editStageId);
  if(!stage)return;
  const cat=G.editCat;
  const results=[];
  G.data.pilots.filter(p=>p.cat===cat).forEach(pilot=>{
    const el=document.getElementById('qt_'+pilot.id);
    const t=el?el.value.trim():'';
    if(t)results.push({pilotId:pilot.id,pilotName:pilot.name,pilotNumber:pilot.number,time:t,position:0,points:0});
  });
  results.sort((a,b)=>a.time.localeCompare(b.time));
  results.forEach((r,i)=>{r.position=i+1;r.points=G.data.points.qualifying[i]||0;});
  stage.qualifying[cat]=results;save();alert('Qualifying salvo!');render();
}

// ====================== BATERIA ======================
function saveB(e,bn){
  e.preventDefault();
  const stage=G.data.stages.find(s=>s.id===G.editStageId);
  if(!stage)return;
  const cat=G.editCat;
  const results=[];
  G.data.pilots.filter(p=>p.cat===cat).forEach(pilot=>{
    const pos=parseInt((document.getElementById('bp'+bn+'_'+pilot.id)||{}).value)||0;
    const pen=parseInt((document.getElementById('bn'+bn+'_'+pilot.id)||{}).value)||0;
    const extra=parseInt((document.getElementById('be'+bn+'_'+pilot.id)||{}).value)||0;
    const penReason=(document.getElementById('br'+bn+'_'+pilot.id)||{}).value||'';
    const vl=(document.getElementById('bv'+bn+'_'+pilot.id)||{}).value||'';
    const dcl=(document.getElementById('bd'+bn+'_'+pilot.id)||{}).checked||false;
    const dclReason=(document.getElementById('bdr'+bn+'_'+pilot.id)||{}).value||'';
    const dnp=(document.getElementById('bx'+bn+'_'+pilot.id)||{}).checked||false;
    let ptsBase=0;if(!dcl&&!dnp&&pos>0)ptsBase=G.data.points.battery[pos-1]||0;
    const ptsTotal=Math.max(0,ptsBase+extra-pen);
    results.push({pilotId:pilot.id,pilotName:pilot.name,pilotNumber:pilot.number,position:pos,pointsBase:ptsBase,pointsExtra:extra,penalties:pen,penaltyReason:penReason,pointsTotal:ptsTotal,bestLap:vl.trim(),disqualified:dcl,disqualificationReason:dclReason,didNotParticipate:dnp});
  });
  stage['battery'+bn][cat]=results;save();alert('‚úÖ '+bn+'¬™ Bateria salva com sucesso!\n\nPontos calculados automaticamente.');render();
}

// ====================== CALCULO ======================
function calcSt(cat){
  return G.data.pilots.filter(p=>p.cat===cat).map(pilot=>{
    let total=0;const rows=[];
    G.data.stages.forEach(stage=>{
      let sp=0,bonus=0,pen=0;
      const q=(stage.qualifying[cat]||[]).find(x=>x.pilotId===pilot.id);
      if(q){sp+=q.points||0;if((stage.qualifying[cat]||[])[0]?.pilotId===pilot.id)bonus+=G.data.points.bestQualifyBonus;}
      ['battery1','battery2'].forEach(bk=>{const b=(stage[bk][cat]||[]).find(x=>x.pilotId===pilot.id);if(b&&!b.disqualified&&!b.didNotParticipate){sp+=(b.pointsTotal||b.points||0);}});
      const allB=[...(stage.battery1[cat]||[]),...(stage.battery2[cat]||[])].filter(b=>b.bestLap&&!b.disqualified&&!b.didNotParticipate);
      if(allB.length){allB.sort((a,b)=>a.bestLap.localeCompare(b.bestLap));if(allB[0].pilotId===pilot.id)bonus+=G.data.points.bestLapBonus;}
      const fp=sp+bonus-pen;total+=fp;
      rows.push({stageName:stage.name,points:fp,bonus,pen});
    });
    return {pilotId:pilot.id,pilotName:pilot.name,pilotNumber:pilot.number,total,rows};
  }).sort((a,b)=>b.total-a.total);
}

function toggleAcc(id){const el=document.getElementById(id);if(el)el.classList.toggle('open');}

// ====================== LOGIN RENDER ======================
function renderLogin(){
  // Garantir que partnerLogos existe
  if(!G.data.partnerLogos) G.data.partnerLogos=[];
  
  return `<div class="login-wrap"><div class="login-box">
    <div class="login-logo">
      ${G.data.logoChampionship?`<img src="${G.data.logoChampionship}" style="max-width:120px;max-height:120px;margin-bottom:10px;border-radius:12px;">`:'<span class="ico">üèéÔ∏è</span>'}
      <h1>${G.data.name}</h1><p>Sistema de Gerenciamento</p></div>
    <div id="lerr" class="err"></div>
    <form onsubmit="doLogin(event)">
      <div class="lfield"><label>Usu√°rio</label><input type="text" id="lU" placeholder="Digite seu usu√°rio" required autocomplete="username"></div>
      <div class="lfield"><label>Senha</label><input type="password" id="lP" placeholder="Digite sua senha" required autocomplete="current-password"></div>
      <button type="submit" class="btn-login">Entrar ‚Üí</button>
    </form>
    <div style="margin-top:20px;text-align:center;font-size:12px;color:#888;">
      <a href="?view=public" style="color:#3b82f6;text-decoration:none;font-weight:700;">üìä Ver Dashboard P√∫blico</a>
    </div>
    ${G.data.partnerLogos&&G.data.partnerLogos.length?`
      <div style="margin-top:24px;padding-top:20px;border-top:1px solid #f3f4f6;">
        <div style="text-align:center;font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px;">Patrocinadores</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:10px;align-items:center;">
          ${G.data.partnerLogos.map(p=>`<div style="background:#fafafa;padding:10px;border-radius:8px;border:1px solid #f3f4f6;display:flex;align-items:center;justify-content:center;min-height:60px;"><img src="${p.logo}" alt="${p.name}" style="max-width:100%;max-height:45px;object-fit:contain;" title="${p.name}"></div>`).join('')}
        </div>
      </div>
    `:''}
  </div></div>`;
}

// ====================== HEADER ======================
function renderHeader(){
  const isA=G.user&&G.user.role==='admin';
  return `<div class="hdr"><div style="display:flex;align-items:center;gap:10px;">
      ${G.data.logoChampionship?`<img src="${G.data.logoChampionship}" style="width:40px;height:40px;border-radius:8px;object-fit:cover;">`:''}
      <h2>${G.data.logoChampionship?'':'üèéÔ∏è '}${G.data.name}</h2><p><span class="rb ${isA?'rb-a':'rb-p'}">${isA?'Admin':'Piloto'}</span>${G.user.name}</p></div><button class="btn-out" onclick="logout()">Sair ‚Ü©</button></div>`;
}

// ====================== NAV ======================
function renderNav(){
  const isA=G.user&&G.user.role==='admin';
  const p=G.page;
  return `<div class="nav">
    <span class="nlbl">Visualiza√ß√£o</span>
    <button class="nb ${p==='standings'?'active':''}" onclick="goto('standings')">üèÜ<br>Ranking<br>Geral</button>
    <button class="nb ${p==='stage-view'?'active':''}" onclick="goto('stage-view')">üìã<br>Ranking<br>Etapas</button>
    <button class="nb ${p==='bestlaps'?'active':''}" onclick="goto('bestlaps')">‚ö°<br>Melhores<br>Voltas</button>
    <button class="nb ${p==='presence'?'active':''}" onclick="goto('presence')">üë•<br>Presen√ßa</button>
    <button class="nb ${p==='pilot-list'?'active':''}" onclick="goto('pilot-list')">ü™ñ<br>Pilotos</button>
    ${isA?`<div class="nsep"></div><span class="nlbl">Administra√ß√£o</span>
    <button class="nb ${p==='home'?'active':''}" onclick="goto('home')">üè†<br>Painel</button>
    <button class="nb ${p==='adm-p'?'active':''}" onclick="goto('adm-p')">üë§<br>Pilotos</button>
    <button class="nb ${p==='adm-k'?'active':''}" onclick="goto('adm-k')">üé≤<br>Karts</button>
    <button class="nb ${p==='adm-s'?'active':''}" onclick="goto('adm-s')">üìÖ<br>Etapas</button>
    <button class="nb ${p==='cfg'?'active':''}" onclick="goto('cfg')">‚öôÔ∏è<br>Config.</button>`:''}
  </div>`;
}

// ====================== RANKING GERAL ======================
function renderStandings(){
  const cat=G.standCat;const st=calcSt(cat);
  let pod='';
  if(st.length>=1){
    pod='<div class="podium">';
    if(st[1])pod+=`<div class="pp pp2"><div class="pm">ü•à</div><div class="pp-pos">2¬∞</div><div class="ppn">${st[1].pilotName}</div><div class="ppp">${st[1].total} pts</div></div>`;
    if(st[0])pod+=`<div class="pp pp1"><div class="pm">ü•á</div><div class="pp-pos">1¬∞</div><div class="ppn">${st[0].pilotName}</div><div class="ppp">${st[0].total} pts</div></div>`;
    if(st[2])pod+=`<div class="pp pp3"><div class="pm">ü•â</div><div class="pp-pos">3¬∞</div><div class="ppn">${st[2].pilotName}</div><div class="ppp">${st[2].total} pts</div></div>`;
    pod+='</div>';
  }
  let tbl=`<div class="tw"><table><thead><tr><th>Pos</th><th>Piloto</th><th>Total</th>`;
  G.data.stages.forEach(s=>{tbl+=`<th>${s.name}</th>`;});
  tbl+=`</tr></thead><tbody>`;
  if(!st.length)tbl+=`<tr><td colspan="20" style="text-align:center;color:#aaa;padding:30px;">Nenhum dado ainda.</td></tr>`;
  st.forEach((s,i)=>{
    const bg=i===0?'#fffbeb':i===1?'#f9fafb':i===2?'#fff8f4':'white';
    const pc=i<3?['p1','p2','p3'][i]:'';
    tbl+=`<tr style="background:${bg}"><td><div class="pb ${pc}">${i+1}</div></td>`;
    tbl+=`<td><strong>${s.pilotName}</strong>${s.pilotNumber?`<br><small style="color:#aaa;">#${s.pilotNumber}</small>`:''}</td>`;
    tbl+=`<td><span class="ptb">${s.total}</span></td>`;
    s.rows.forEach(r=>{
      tbl+=`<td><div style="font-weight:800;">${r.points}</div>`;
      if(r.bonus>0)tbl+=`<div style="font-size:11px;color:#10b981;">+${r.bonus}</div>`;
      if(r.pen>0)tbl+=`<div style="font-size:11px;color:#dc2626;">-${r.pen}</div>`;
      tbl+=`</td>`;
    });
    tbl+=`</tr>`;
  });
  tbl+=`</tbody></table></div>`;
  return `<div class="card"><div class="ct">üèÜ Ranking Geral</div>
    <div class="tabs">
      <button class="tab ${cat==='Dinos'?'active':''}" onclick="G.standCat='Dinos';render()">ü¶ñ DINOS SENIOR</button>
      <button class="tab ${cat==='Baby Dinos'?'active':''}" onclick="G.standCat='Baby Dinos';render()">ü¶ï DINOS GRADUADOS</button>
    </div>${pod}${tbl}</div>`;
}

// ====================== RANKING ETAPAS ======================
function renderStageView(){
  const cat=G.viewCat;let cards='';
  if(!G.data.stages.length){cards='<p style="text-align:center;color:#aaa;padding:30px;">Nenhuma etapa ainda.</p>';}
  else{
    G.data.stages.forEach(stage=>{
      const isO=G.openStageId===stage.id;
      const ds=stage.date?new Date(stage.date+'T00:00:00').toLocaleDateString('pt-BR'):'';
      const draw=(stage.kartDraw&&stage.kartDraw[cat])||[];
      const q=stage.qualifying[cat]||[];
      let body='';
      if(isO){
        body+=`<div class="sectit">üé≤ Karts Sorteados</div>`;
        if(draw.length){draw.forEach((r,i)=>{body+=`<div class="krow"><div style="display:flex;align-items:center;gap:10px;">${r.pilotNumber?`<div class="pnum">${r.pilotNumber}</div>`:''}<strong>${i+1}. ${r.pilotName}</strong></div><span class="ktag">Kart ${r.kartNum}</span></div>`;});}
        else body+=`<p style="color:#aaa;font-size:13px;font-style:italic;">Sorteio nao realizado.</p>`;
        body+=`<div class="sectit">‚è± Qualifying</div>`;
        if(q.length){
          body+=`<div class="tw"><table><thead><tr><th>Pos</th><th>Piloto</th><th>Tempo</th><th>Pts</th></tr></thead><tbody>`;
          q.forEach((r,i)=>{const pc=i<3?['p1','p2','p3'][i]:'';body+=`<tr><td><div class="pb ${pc}">${i+1}</div></td><td><strong>${r.pilotName}</strong></td><td style="font-family:monospace;font-weight:700;color:#3b82f6;">${r.time}</td><td style="font-weight:800;">${r.points}</td></tr>`;});
          body+=`</tbody></table></div>`;
        }else body+=`<p style="color:#aaa;font-size:13px;font-style:italic;">Sem dados.</p>`;
        ['battery1','battery2'].forEach((bk,bi)=>{
          const bArr=stage[bk][cat]||[];
          body+=`<div class="sectit">üèÅ ${bi+1}¬™ Bateria</div>`;
          if(bArr.length){
            const sorted=[...bArr].sort((a,b)=>{if(a.disqualified||a.didNotParticipate)return 1;if(b.disqualified||b.didNotParticipate)return -1;return a.position-b.position;});
            body+=`<div class="tw"><table><thead><tr><th>Pos</th><th>Piloto</th><th>Melhor Volta</th><th>Pts</th><th>Status</th></tr></thead><tbody>`;
            sorted.forEach(r=>{
              let sl='',sc='';
              if(r.disqualified){sl='DCLAS.';sc='color:#dc2626;font-weight:800;';}
              else if(r.didNotParticipate){sl='Nao Part.';sc='color:#aaa;';}
              else if(r.penalties>0){sl='-'+r.penalties+' pts';sc='color:#f59e0b;font-weight:700;';}
              const sp=r.disqualified||r.didNotParticipate?'‚Äî':r.position+'¬∞';
              const pp=r.disqualified||r.didNotParticipate?'0':r.points;
              const pc=(!r.disqualified&&!r.didNotParticipate&&r.position>0&&r.position<4)?['p1','p2','p3'][r.position-1]:'';
              body+=`<tr><td><div class="pb ${pc}">${sp}</div></td><td><strong>${r.pilotName}</strong></td><td style="font-family:monospace;font-weight:700;color:#10b981;">${r.bestLap||'‚Äî'}</td><td style="font-weight:800;">${pp}</td><td style="${sc}">${sl}</td></tr>`;
            });
            body+=`</tbody></table></div>`;
          }else body+=`<p style="color:#aaa;font-size:13px;font-style:italic;">Sem dados.</p>`;
        });
      }
      cards+=`<div class="stg-card ${isO?'open':''}" onclick="G.openStageId=G.openStageId==='${stage.id}'?null:'${stage.id}';render()">
        <div class="stg-hdr"><div><div class="stg-name">${stage.name}</div><div class="stg-date">üìÖ ${ds}</div></div><span style="font-size:22px;color:#ccc;">${isO?'‚ñ≤':'‚ñº'}</span></div>
        ${isO?`<div class="stg-body" onclick="event.stopPropagation()">${body}</div>`:''}
      </div>`;
    });
  }
  return `<div class="card"><div class="ct">üìã Ranking das Etapas</div>
    <div class="tabs">
      <button class="tab ${cat==='Dinos'?'active':''}" onclick="G.viewCat='Dinos';render()">ü¶ñ DINOS SENIOR</button>
      <button class="tab ${cat==='Baby Dinos'?'active':''}" onclick="G.viewCat='Baby Dinos';render()">ü¶ï DINOS GRADUADOS</button>
    </div>
    <p style="font-size:13px;color:#888;margin-bottom:14px;">Toque em uma etapa para expandir.</p>
    ${cards}</div>`;
}

// ====================== MELHORES VOLTAS ======================
function renderBestLaps(){
  let html='';
  ['Dinos','Baby Dinos'].forEach(cat=>{
        const catLabel=cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS';
    html+=`<div style="margin-bottom:22px;"><div style="font-weight:900;font-size:15px;margin-bottom:10px;">${cat==='Dinos'?'ü¶ñ':'ü¶ï'} ${cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS'}</div>`;
    let found=false;
    G.data.stages.forEach(stage=>{
      const allB=[...(stage.battery1[cat]||[]),...(stage.battery2[cat]||[])].filter(b=>b.bestLap&&!b.disqualified&&!b.didNotParticipate);
      if(allB.length){allB.sort((a,b)=>a.bestLap.localeCompare(b.bestLap));html+=`<div class="brow"><span style="font-size:26px;">üèÅ</span><div><div class="btime">${allB[0].bestLap}</div><div class="bpilot">${allB[0].pilotName}</div><div class="bstage">${stage.name} ‚Äî Baterias</div></div></div>`;found=true;}
      const q=stage.qualifying[cat]||[];
      if(q.length){html+=`<div class="brow"><span style="font-size:26px;">‚è±</span><div><div class="btime">${q[0].time}</div><div class="bpilot">${q[0].pilotName}</div><div class="bstage">${stage.name} ‚Äî Qualifying</div></div></div>`;found=true;}
    });
    if(!found)html+=`<p style="color:#aaa;font-size:13px;font-style:italic;">Sem dados ainda.</p>`;
    html+=`</div>`;
  });
  return `<div class="card"><div class="ct">‚ö° Melhores Voltas</div>${html}</div>`;
}

// ====================== PRESEN√áA ======================
function renderPresence(){
  if(!G.data.stages.length)return `<div class="card"><div class="ct">üë• Presen√ßa</div><p style="text-align:center;color:#aaa;padding:30px;">Nenhuma etapa ainda.</p></div>`;
  let html=`<div class="card"><div class="ct">üë• Presen√ßa por Etapa</div>`;
  G.data.stages.forEach(stage=>{
    const ds=stage.date?new Date(stage.date+'T00:00:00').toLocaleDateString('pt-BR'):'';
    html+=`<div class="acc"><div class="ach" onclick="toggleAcc('ac_${stage.id}')">üìÖ ${stage.name} ‚Äî ${ds} <span>‚ñº</span></div><div class="acb" id="ac_${stage.id}">`;
    ['Dinos','Baby Dinos'].forEach(cat=>{
        const catLabel=cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS';
      const b1=stage.battery1[cat]||[];const b2=stage.battery2[cat]||[];
      const rows=G.data.pilots.filter(p=>p.cat===cat).map(pilot=>{
        const r1=b1.find(x=>x.pilotId===pilot.id);const r2=b2.find(x=>x.pilotId===pilot.id);
        let status='sem-dado';
        if(r1||r2){if((r1&&r1.disqualified)||(r2&&r2.disqualified))status='dcl';else if((r1&&r1.didNotParticipate)&&(!r2||(r2&&r2.didNotParticipate)))status='absent';else status='present';}
        const name=(r1&&r1.pilotName)||(r2&&r2.pilotName)||pilot.name;
        return{name,status};
      });
      const nP=rows.filter(r=>r.status==='present').length;
      const nA=rows.filter(r=>r.status==='absent').length;
      const nD=rows.filter(r=>r.status==='dcl').length;
      html+=`<div style="margin-bottom:16px;"><div style="font-weight:800;font-size:14px;margin-bottom:8px;">${cat==='Dinos'?'ü¶ñ':'ü¶ï'} ${cat==='Dinos'?'DINOS SENIOR':'DINOS GRADUADOS'}</div>
        <div style="display:flex;gap:14px;flex-wrap:wrap;font-size:13px;margin-bottom:10px;">
          <span style="color:#16a34a;">‚úÖ Presentes: <strong>${nP}</strong></span>
          <span style="color:#dc2626;">‚ùå Ausentes: <strong>${nA}</strong></span>
          ${nD?`<span style="color:#c2410c;">‚õî Dclas.: <strong>${nD}</strong></span>`:''}
        </div><div class="pg">`;
      rows.forEach(r=>{let cls='',ic='',lb='';if(r.status==='present'){cls='pres';ic='‚úÖ';lb='Presente';}else if(r.status==='absent'){cls='abs';ic='‚ùå';lb='Ausente';}else if(r.status==='dcl'){cls='dcl';ic='‚õî';lb='Desclassificado';}else{cls='abs';ic='‚Äî';lb='Sem dado';}html+=`<div class="pi ${cls}">${ic}<br>${r.name}<br><small>${lb}</small></div>`;});
      html+=`</div></div>`;
    });
    html+=`</div></div>`;
  });
  return html+`</div>`;
}

// ====================== LISTA PILOTOS (visualiza√ß√£o) ======================
function renderPilotList(){
  const dinos=G.data.pilots.filter(p=>p.cat==='Dinos');
  const baby=G.data.pilots.filter(p=>p.cat==='Baby Dinos');
  let html=`<div class="card"><div class="ct">ü™ñ Pilotos do Campeonato</div>
    <div class="stats">
      <div class="stc"><div class="stn">${G.data.pilots.length}</div><div class="stl">Total</div></div>
      <div class="stc"><div class="stn">${dinos.length}</div><div class="stl">DINOS SENIOR</div></div>
      <div class="stc"><div class="stn">${baby.length}</div><div class="stl">DINOS GRADUADOS</div></div>
    </div>
    <div style="font-weight:900;font-size:14px;margin-bottom:10px;">ü¶ñ DINOS SENIOR</div>`;
  if(!dinos.length)html+=`<p style="color:#aaa;font-size:13px;margin-bottom:14px;">Nenhum piloto.</p>`;
  dinos.forEach(p=>{html+=`<div class="li"><div style="display:flex;align-items:center;gap:12px;">${p.number?`<div class="pnum">${p.number}</div>`:'<div style="width:36px;height:36px;background:#f3f4f6;border-radius:50%;"></div>'}<strong>${p.name}</strong></div><span class="catd cd">DINOS SENIOR</span></div>`;});
  html+=`<div style="font-weight:900;font-size:14px;margin:16px 0 10px;">ü¶ï DINOS GRADUADOS</div>`;
  if(!baby.length)html+=`<p style="color:#aaa;font-size:13px;">Nenhum piloto.</p>`;
  baby.forEach(p=>{html+=`<div class="li"><div style="display:flex;align-items:center;gap:12px;">${p.number?`<div class="pnum">${p.number}</div>`:'<div style="width:36px;height:36px;background:#f3f4f6;border-radius:50%;"></div>'}<strong>${p.name}</strong></div><span class="catd cb">DINOS GRADUADOS</span></div>`;});
  return html+`</div>`;
}

// ====================== ADMIN: PAINEL ======================
function renderHome(){
  const d=G.data;
  return `<div class="card"><div class="ct">üè† Painel do Administrador</div>
    <div class="stats">
      <div class="stc"><div class="stn">${d.pilots.length}</div><div class="stl">Pilotos</div></div>
      <div class="stc"><div class="stn">${d.stages.length}</div><div class="stl">Etapas</div></div>
      <div class="stc"><div class="stn">${d.karts.length}</div><div class="stl">Karts</div></div>
    </div>
    ${d.regulation?`<div style="padding:14px;background:#f9fafb;border-radius:10px;white-space:pre-wrap;font-size:14px;color:#444;margin-top:8px;">${d.regulation}</div>`:''}
    ${d.partners.length?`<div style="margin-top:14px;"><div style="font-weight:800;font-size:13px;margin-bottom:8px;">ü§ù Parceiros</div><div style="display:flex;flex-wrap:wrap;gap:8px;">${d.partners.map(p=>`<span style="background:#f3f4f6;padding:6px 14px;border-radius:20px;font-size:13px;font-weight:700;">${p}</span>`).join('')}</div></div>`:''}
  </div>`;
}

// ====================== ADMIN: PILOTOS ======================
function renderAdmP(){
  const dinos=G.data.pilots.filter(p=>p.cat==='Dinos');
  const baby=G.data.pilots.filter(p=>p.cat==='Baby Dinos');
  return `<div class="card"><div class="ct">üë§ Gerenciar Pilotos</div>
    <div class="fsec"><h3>Adicionar</h3>
      <form onsubmit="addPilot(event)">
        <div class="f"><label>Nome</label><input type="text" id="pN" placeholder="Nome do piloto" required></div>
        <div class="frow">
          <div class="f"><label>Numero</label><input type="text" id="pNm" placeholder="Ex: 77"></div>
          <div class="f"><label>Categoria</label><select id="pC"><option value="Dinos">DINOS SENIOR</option><option value="Baby Dinos">DINOS GRADUADOS</option></select></div>
        </div>
        <button type="submit" class="btn bg">‚ûï Adicionar</button>
      </form>
    </div>
    <div style="font-weight:900;font-size:14px;margin-bottom:10px;">ü¶ñ DINOS SENIOR (${dinos.length})</div>
    ${dinos.map(p=>`<div class="li"><div style="display:flex;align-items:center;gap:12px;">${p.number?`<div class="pnum">${p.number}</div>`:''}<div><strong>${p.name}</strong><br><span class="catd cd">DINOS SENIOR</span></div></div><button class="dbtn" onclick="delPilot('${p.id}')">Excluir</button></div>`).join('')||'<p style="color:#aaa;margin-bottom:12px;">Nenhum.</p>'}
    <div style="font-weight:900;font-size:14px;margin:16px 0 10px;">ü¶ï DINOS GRADUADOS (${baby.length})</div>
    ${baby.map(p=>`<div class="li"><div style="display:flex;align-items:center;gap:12px;">${p.number?`<div class="pnum">${p.number}</div>`:''}<div><strong>${p.name}</strong><br><span class="catd cb">DINOS GRADUADOS</span></div></div><button class="dbtn" onclick="delPilot('${p.id}')">Excluir</button></div>`).join('')||'<p style="color:#aaa;">Nenhum.</p>'}
  </div>`;
}

// ====================== ADMIN: KARTS ======================
function renderAdmK(){
  return `<div class="card"><div class="ct">üé≤ Karts</div>
    <div class="fsec"><h3>Cadastrar</h3>
      <form onsubmit="addKart(event)">
        <div class="f"><label>Numero</label><input type="text" id="kN" placeholder="Ex: 01" required></div>
        <button type="submit" class="btn bg">‚ûï Adicionar</button>
      </form>
    </div>
    <div class="info ib">‚ÑπÔ∏è O sorteio de cada etapa fica em: Etapas ‚Üí Editar ‚Üí aba Sorteio.</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px;">
      ${G.data.karts.map(k=>`<div style="background:#f9fafb;padding:12px;border-radius:10px;text-align:center;position:relative;border:1px solid #f3f4f6;"><div style="font-weight:900;">Kart ${k.num}</div><button onclick="delKart('${k.id}')" style="position:absolute;top:4px;right:4px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:5px;padding:1px 7px;cursor:pointer;">√ó</button></div>`).join('')||'<p style="color:#aaa;">Nenhum kart.</p>'}
    </div>
  </div>`;
}

// ====================== ADMIN: ETAPAS ======================
function renderAdmS(){
  return `<div class="card"><div class="ct">üìÖ Gerenciar Etapas</div>
    <div class="fsec"><h3>Nova Etapa</h3>
      <form onsubmit="addStage(event)">
        <div class="frow">
          <div class="f"><label>Nome</label><input type="text" id="sN" placeholder="Ex: 1a Etapa" required></div>
          <div class="f"><label>Data</label><input type="date" id="sD" required></div>
        </div>
        <button type="submit" class="btn bg">‚ûï Criar</button>
      </form>
    </div>
    ${G.data.stages.length===0?'<p style="color:#aaa;">Nenhuma etapa.</p>':''}
    ${G.data.stages.map(s=>`<div class="li"><div><strong>${s.name}</strong><br><span style="font-size:13px;color:#888;">üìÖ ${new Date(s.date+'T00:00:00').toLocaleDateString('pt-BR')}</span></div><div style="display:flex;gap:8px;"><button class="btn bb bsm" onclick="openEdit('${s.id}')">‚úèÔ∏è Editar</button><button class="dbtn" onclick="delStage('${s.id}')">Excluir</button></div></div>`).join('')}
  </div>`;
}

// ====================== ADMIN: EDITOR ETAPA ======================
function renderEdit(){
  const stage=G.data.stages.find(s=>s.id===G.editStageId);
  if(!stage){goto('adm-s');return'';}
  const tab=G.editTab,cat=G.editCat;
  const ds=stage.date?new Date(stage.date+'T00:00:00').toLocaleDateString('pt-BR'):'';
  const pilots=G.data.pilots.filter(p=>p.cat===cat);
  let body='';
  if(tab==='draw'){
    const draw=(stage.kartDraw&&stage.kartDraw[cat])||[];
    body=`<div class="info ib">üé≤ O sorteio fica gravado permanentemente nesta etapa.</div>
    ${draw.length?`<div style="margin-bottom:16px;"><div style="font-weight:800;margin-bottom:10px;">‚úÖ Sorteio arquivado ‚Äî ${cat}:</div>${draw.map((r,i)=>`<div class="krow"><div style="display:flex;align-items:center;gap:10px;">${r.pilotNumber?`<div class="pnum">${r.pilotNumber}</div>`:''}<strong>${i+1}. ${r.pilotName}</strong></div><span class="ktag">Kart ${r.kartNum}</span></div>`).join('')}</div>`:`<div class="info iy">‚ö†Ô∏è Nenhum sorteio para ${cat} ainda.</div>`}
    <form onsubmit="doDraw(event)"><button type="submit" class="btn br">üé≤ ${draw.length?'Refazer':'Realizar'} Sorteio ‚Äî ${cat}</button></form>`;
  }
  if(tab==='qualifying'){
    const ex=stage.qualifying[cat]||[];
    body=`<div class="info ib">‚è± Melhor tempo de cada piloto nas 2 voltas. Formato: <code>1:23.456</code></div>
    <form onsubmit="saveQ(event)">
      ${pilots.map(p=>{const e2=ex.find(x=>x.pilotId===p.id);return `<div class="f"><label>${p.name}${p.number?' #'+p.number:''}</label><input type="text" id="qt_${p.id}" placeholder="1:23.456" value="${e2?e2.time:''}"></div>`;}).join('')}
      ${!pilots.length?'<p style="color:#aaa;">Nenhum piloto nesta categoria.</p>':''}
      <button type="submit" class="btn bg">üíæ Salvar Qualifying</button>
    </form>`;
  }
  if(tab==='battery1'||tab==='battery2'){
    const bn=tab==='battery1'?1:2;
    const ex=stage['battery'+bn][cat]||[];
    body=`<div class="info ib">üèÅ Posicao, melhor volta, penalidades, desclassificados e ausentes.</div>
    <form onsubmit="saveB(event,${bn})">
      <div class="tw"><table><thead><tr><th>Piloto</th><th>Posicao</th><th>Melhor Volta</th><th>Penalidade</th><th style="text-align:center">Dclas.</th><th style="text-align:center">N.Part.</th></tr></thead><tbody>
      ${pilots.map(p=>{const e2=ex.find(x=>x.pilotId===p.id)||{};return `<tr><td><strong>${p.name}</strong>${p.number?`<br><small style="color:#aaa;">#${p.number}</small>`:''}</td><td><input type="number" id="bp${bn}_${p.id}" min="1" placeholder="1" value="${e2.position||''}" style="width:60px;padding:8px;border:2px solid #e5e7eb;border-radius:7px;font-size:15px;"></td><td><input type="text" id="bv${bn}_${p.id}" placeholder="1:23.456" value="${e2.bestLap||''}" style="width:110px;padding:8px;border:2px solid #e5e7eb;border-radius:7px;font-size:15px;"></td><td><input type="number" id="bn${bn}_${p.id}" min="0" value="${e2.penalties||0}" style="width:60px;padding:8px;border:2px solid #e5e7eb;border-radius:7px;font-size:15px;"></td><td style="text-align:center"><input type="checkbox" id="bd${bn}_${p.id}" ${e2.disqualified?'checked':''} style="width:22px;height:22px;cursor:pointer;"></td><td style="text-align:center"><input type="checkbox" id="bx${bn}_${p.id}" ${e2.didNotParticipate?'checked':''} style="width:22px;height:22px;cursor:pointer;"></td></tr>`;}).join('')}
      </tbody></table></div>
      ${!pilots.length?'<p style="color:#aaa;margin-top:10px;">Nenhum piloto.</p>':''}
      <button type="submit" class="btn bg" style="margin-top:14px;">üíæ Salvar ${bn}¬™ Bateria</button>
    </form>`;
  }
  return `<div class="wrap">${renderHeader()}<div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:16px;">
      <div><div class="ct" style="margin-bottom:4px;">‚úèÔ∏è ${stage.name}</div><div style="font-size:13px;color:#888;">üìÖ ${ds}</div></div>
      <button class="btn bw bsm" onclick="goto('adm-s')">‚Üê Voltar</button>
    </div>
    <div class="tabs">
      <button class="tab ${tab==='draw'?'active':''}" onclick="setTab('draw')">üé≤ Sorteio</button>
      <button class="tab ${tab==='qualifying'?'active':''}" onclick="setTab('qualifying')">‚è± Qualifying</button>
      <button class="tab ${tab==='battery1'?'active':''}" onclick="setTab('battery1')">üèÅ 1¬™ Bateria</button>
      <button class="tab ${tab==='battery2'?'active':''}" onclick="setTab('battery2')">üèÅ 2¬™ Bateria</button>
    </div>
    <div class="tabs" style="margin-top:-8px;">
      <button class="tab ${cat==='Dinos'?'active':''}" onclick="setCat('Dinos')">ü¶ñ DINOS SENIOR</button>
      <button class="tab ${cat==='Baby Dinos'?'active':''}" onclick="setCat('Baby Dinos')">ü¶ï DINOS GRADUADOS</button>
    </div>
    ${body}
  </div></div>`;
}

// ====================== ADMIN: CONFIG ======================
function renderCfg(){
  const d=G.data;
  // Garantir que partnerLogos existe
  if(!d.partnerLogos) d.partnerLogos=[];
  if(!d.logoChampionship) d.logoChampionship='';
  
  return `<div class="card"><div class="ct">‚öôÔ∏è Configuracoes</div>
    <div class="fsec"><h3>Campeonato</h3>
      <div class="f"><label>Nome</label><input type="text" id="cN" value="${d.name}"></div>
      <div class="f"><label>Regulamento</label><textarea id="cR" rows="5" style="width:100%;padding:10px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;line-height:1.5;">${d.regulation||''}</textarea></div>
      <div class="f"><label>Parceiros (legado - use logos abaixo)</label><input type="text" id="cP" value="${(d.partners||[]).join(', ')}" placeholder="Deixe em branco se usar logos"></div>
      <button class="btn bg" onclick="saveCfg()">üíæ Salvar Informa√ß√µes</button>
    </div>
    <div class="fsec"><h3>Logo do Campeonato</h3>
      ${d.logoChampionship?`<div style="text-align:center;margin-bottom:12px;"><img src="${d.logoChampionship}" style="max-width:150px;max-height:150px;border-radius:12px;border:2px solid #f3f4f6;"><br><button class="btn br bsm" onclick="removeChampLogo()" style="margin-top:10px;">üóëÔ∏è Remover Logo</button></div>`:'<div class="info ib" style="margin-bottom:12px;">Nenhuma logo ainda. Adicione abaixo.</div>'}
      <label class="btn bb" style="display:block;text-align:center;cursor:pointer;">üì§ Upload Logo do Campeonato<input type="file" accept="image/*" onchange="uploadChampLogo(event)" style="display:none;"></label>
      <p style="font-size:12px;color:#888;margin-top:8px;text-align:center;">Max 500KB ‚Ä¢ Formatos: JPG, PNG, GIF</p>
    </div>
    <div class="fsec"><h3>Logos dos Parceiros</h3>
      ${d.partnerLogos&&d.partnerLogos.length?`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;margin-bottom:14px;">${d.partnerLogos.map(p=>`<div style="background:white;padding:10px;border-radius:10px;border:1px solid #f3f4f6;text-align:center;position:relative;"><img src="${p.logo}" style="max-width:100%;max-height:60px;object-fit:contain;margin-bottom:6px;"><div style="font-size:12px;font-weight:700;color:#333;">${p.name}</div><button onclick="delPartnerLogo('${p.id}')" style="position:absolute;top:4px;right:4px;background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:5px;padding:2px 8px;cursor:pointer;font-size:12px;">√ó</button></div>`).join('')}</div>`:'<div class="info iy" style="margin-bottom:12px;">Nenhum parceiro ainda. Adicione abaixo.</div>'}
      <form onsubmit="addPartnerLogo(event)">
        <div class="f"><label>Nome do Parceiro</label><input type="text" id="plName" placeholder="Ex: Empresa XYZ"></div>
        <div class="f"><label>Logo do Parceiro</label><input type="file" id="plFile" accept="image/*" style="padding:8px;"></div>
        <p style="font-size:12px;color:#888;margin-bottom:8px;">Max 300KB ‚Ä¢ Formatos: JPG, PNG, GIF</p>
        <button type="submit" class="btn bg">‚ûï Adicionar Parceiro</button>
      </form>
      <button class="btn bg" onclick="saveCfg()">üíæ Salvar</button>
    </div>
    <div class="fsec"><h3>Pontuacao</h3>
      <div class="f"><label>Qualifying ‚Äî 1o ao ultimo</label><input type="text" id="cQP" value="${d.points.qualifying.join(', ')}"></div>
      <div class="f"><label>Baterias ‚Äî 1o ao ultimo</label><input type="text" id="cBP" value="${d.points.battery.join(', ')}"></div>
      <div class="frow">
        <div class="f"><label>Bonus melhor volta bateria</label><input type="number" id="cBL" value="${d.points.bestLapBonus}"></div>
        <div class="f"><label>Bonus melhor volta qualifying</label><input type="number" id="cQL" value="${d.points.bestQualifyBonus}"></div>
      </div>
      <button class="btn bg" onclick="savePts()">üíæ Salvar Pontuacao</button>
    </div>
    <div class="fsec"><h3>Backup</h3>
      <button class="btn bb" onclick="expData()">üì• Exportar Backup (JSON)</button>
      <label class="btn bw" style="display:block;text-align:center;cursor:pointer;margin-top:8px;">üì§ Importar Backup<input type="file" accept=".json" onchange="impData(event)" style="display:none;"></label>
    </div>
    <div class="fsec"><h3>Credenciais de Acesso</h3>
      <div style="border-radius:10px;overflow:hidden;border:1px solid #f3f4f6;">
        <div style="display:flex;gap:12px;align-items:center;padding:13px 16px;background:#fff5f5;border-bottom:1px solid #f3f4f6;">
          <span style="font-size:22px;">üëë</span><div><strong>Administrador</strong><br><span style="font-size:13px;color:#666;">usuario: <code>admin</code> | senha: <code>admin123</code></span></div></div>
        <div style="display:flex;gap:12px;align-items:center;padding:13px 16px;background:#eff6ff;">
          <span style="font-size:22px;">ü™ñ</span><div><strong>Pilotos (todos compartilham)</strong><br><span style="font-size:13px;color:#666;">usuario: <code>piloto</code> | senha: <code>piloto123</code></span></div></div>
      </div>
    </div>
  </div>`;
}
function saveCfg(){G.data.name=document.getElementById('cN').value||G.data.name;G.data.regulation=document.getElementById('cR').value;G.data.partners=(document.getElementById('cP').value||'').split(',').map(x=>x.trim()).filter(Boolean);save();alert('‚úÖ Configura√ß√µes salvas!');render();}
function savePts(){G.data.points.qualifying=document.getElementById('cQP').value.split(',').map(x=>parseInt(x)).filter(n=>!isNaN(n));G.data.points.battery=document.getElementById('cBP').value.split(',').map(x=>parseInt(x)).filter(n=>!isNaN(n));G.data.points.bestLapBonus=parseInt(document.getElementById('cBL').value)||0;G.data.points.bestQualifyBonus=parseInt(document.getElementById('cQL').value)||0;save();alert('Pontuacao salva!');}
function expData(){const blob=new Blob([JSON.stringify(G.data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='kart-backup-'+new Date().toISOString().slice(0,10)+'.json';a.click();}
function impData(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{G.data=JSON.parse(ev.target.result);save();alert('Importado!');render();}catch{alert('Arquivo invalido.');}};r.readAsText(f);}


// ====================== DASHBOARD P√öBLICO ======================
function renderPublicDashboard(){
  const d=G.data;
  if(!d.partnerLogos)d.partnerLogos=[];
  const page=G.page;
  
  let content='';
  if(page==='standings')content=renderStandings();
  else if(page==='stage-view')content=renderStageView();
  else if(page==='bestlaps')content=renderBestLaps();
  else if(page==='presence')content=renderPresence();
  else if(page==='pilot-list')content=renderPilotList();
  else{
    // Home do dashboard p√∫blico
    const dinos=d.pilots.filter(p=>p.cat==='Dinos');
    const baby=d.pilots.filter(p=>p.cat==='Baby Dinos');
    content=`
    <div class="public-card">
      <div class="public-title">üìä Estat√≠sticas do Campeonato</div>
      <div class="dash-stats">
        <div class="dash-stat"><div class="dash-stat-num">${d.pilots.length}</div><div class="dash-stat-label">Pilotos</div></div>
        <div class="dash-stat"><div class="dash-stat-num">${d.stages.length}</div><div class="dash-stat-label">Etapas</div></div>
        <div class="dash-stat"><div class="dash-stat-num">${d.karts.length}</div><div class="dash-stat-label">Karts</div></div>
        <div class="dash-stat"><div class="dash-stat-num">2</div><div class="dash-stat-label">Categorias</div></div>
      </div>
      ${d.regulation?`<div style="padding:16px;background:#f9fafb;border-radius:12px;white-space:pre-wrap;font-size:14px;color:#555;line-height:1.6;">${d.regulation}</div>`:''}
    </div>
    ${renderStandings()}
    `;
  }
  
  return `
  <div class="public-wrap">
    <div class="wrap">
      <div class="public-header">
        <h1>
          ${d.logoChampionship?`<img src="${d.logoChampionship}" class="logo-small">`:'üèéÔ∏è'}
          ${d.name}
        </h1>
        <div class="public-nav">
          <button class="public-nav-btn ${page==='standings'||!page?'active':''}" onclick="G.page='standings';render()">üèÜ Rankings</button>
          <button class="public-nav-btn ${page==='stage-view'?'active':''}" onclick="G.page='stage-view';render()">üìã Etapas</button>
          <button class="public-nav-btn ${page==='bestlaps'?'active':''}" onclick="G.page='bestlaps';render()">‚ö° Voltas</button>
          <button class="public-nav-btn ${page==='presence'?'active':''}" onclick="G.page='presence';render()">üë• Presen√ßa</button>
          <button class="public-nav-btn ${page==='pilot-list'?'active':''}" onclick="G.page='pilot-list';render()">ü™ñ Pilotos</button>
          <button class="public-nav-btn" onclick="window.location.href=window.location.pathname" style="background:#10b981;">üîê Login</button>
        </div>
      </div>
      ${content}
      ${d.partnerLogos&&d.partnerLogos.length?`
        <div class="public-card">
          <div class="public-title">ü§ù Patrocinadores</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:15px;">
            ${d.partnerLogos.map(p=>`<div style="background:#fafafa;padding:15px;border-radius:10px;border:1px solid #f3f4f6;display:flex;align-items:center;justify-content:center;min-height:80px;"><img src="${p.logo}" alt="${p.name}" style="max-width:100%;max-height:60px;object-fit:contain;" title="${p.name}"></div>`).join('')}
          </div>
        </div>
      `:''}
      <div class="public-footer">
        ${d.name} ¬© ${new Date().getFullYear()}<br>
        Sistema de Gerenciamento de Campeonato
      </div>
    </div>
  </div>`;
}

// ====================== RENDER PRINCIPAL ======================
function render(){
  ensureDataCompat();
  const el=document.getElementById('APP');if(!el)return;
  if(G.isPublic){el.innerHTML=renderPublicDashboard();return;}
  if(!G.user){el.innerHTML=renderLogin();return;}
  if(G.page==='edit'){el.innerHTML=renderEdit();return;}
  const adminPages=['home','adm-p','adm-k','adm-s','cfg'];
  if(G.user.role!=='admin'&&adminPages.includes(G.page))G.page='standings';
  let content='';const p=G.page;
  if(p==='standings')content=renderStandings();
  else if(p==='stage-view')content=renderStageView();
  else if(p==='bestlaps')content=renderBestLaps();
  else if(p==='presence')content=renderPresence();
  else if(p==='pilot-list')content=renderPilotList();
  else if(p==='home')content=renderHome();
  else if(p==='adm-p')content=renderAdmP();
  else if(p==='adm-k')content=renderAdmK();
  else if(p==='adm-s')content=renderAdmS();
  else if(p==='cfg')content=renderCfg();
  else content=G.user.role==='admin'?renderHome():renderStandings();
  const bar=G.user.role==='pilot'?`<div class="readonly-bar">üëÅ Modo Visualiza√ß√£o ‚Äî Somente Leitura</div>`:'';
  el.innerHTML=`<div class="wrap">${renderHeader()}${renderNav()}${bar}${content}</div>`;
}
setTimeout(()=>render(),50);
</script>
</body>
</html>
